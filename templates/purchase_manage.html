<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>采购管理</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
        --primary: #00b894;  /* 绿色主色调 */
        --secondary: #55efc4;  /* 浅绿色 */
        --accent: #fdcb6e;  /* 黄色强调色 */
        --success: #00b894;
        --danger: #d63031;
        --dark: #2d3436;
        --light: #f5f6fa;
        --supplier: #6c5ce7;  /* 供应商紫色 */
        }

        body {
        font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        background: linear-gradient(135deg, #55efc4, #81ecec, #74b9ff);
        margin: 0;
        padding: 0;
        min-height: 100vh;
        animation: gradientBG 15s ease infinite;
        background-size: 400% 400%;
        }

        @keyframes gradientBG {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
        }

        .container {
        max-width: 1200px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        padding: 30px;
        margin: 40px auto;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        }

        h2 {
        color: var(--primary);
        font-weight: 700;
        margin-bottom: 25px;
        position: relative;
        padding-bottom: 15px;
        }

        h2::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--accent));
        border-radius: 2px;
        }

        .btn-secondary {
        background: linear-gradient(135deg, #636e72, #2d3436);
        border: none;
        color: white;
        border-radius: 10px;
        padding: 8px 16px;
        transition: all 0.3s ease;
        }

        .btn-secondary:hover {
        background: linear-gradient(135deg, #2d3436, #636e72);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border: none;
        border-radius: 10px;
        padding: 10px 20px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 184, 148, 0.3);
        }

        .btn-primary:hover {
        background: linear-gradient(135deg, var(--secondary), var(--primary));
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 184, 148, 0.4);
        }

        .btn-danger {
        background: linear-gradient(135deg, var(--danger), #ff7675);
        border: none;
        border-radius: 8px;
        transition: all 0.3s ease;
        }

        .btn-danger:hover {
        background: linear-gradient(135deg, #ff7675, var(--danger));
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(214, 48, 49, 0.3);
        }

        #addPurchaseForm {
        background: rgba(248, 249, 250, 0.8);
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .form-control {
        border-radius: 10px;
        padding: 10px 15px;
        border: 2px solid #eee;
        transition: all 0.3s ease;
        }

        .form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 184, 148, 0.2);
        }

        .form-label {
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 8px;
        }

        .table {
        margin-top: 25px;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .table thead {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        }

        .table th {
        font-weight: 600;
        padding: 15px;
        text-align: center;
        vertical-align: middle;
        border: none;
        }

        .table td {
        padding: 12px 15px;
        vertical-align: middle;
        text-align: center;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .table tbody tr:nth-child(even) {
        background-color: rgba(248, 249, 250, 0.5);
        }

        .table tbody tr:hover {
        background-color: rgba(85, 239, 196, 0.1);
        transform: translateX(5px);
        transition: all 0.2s ease;
        }

        .badge {
        padding: 6px 12px;
        border-radius: 50px;
        font-weight: 500;
        }

        .bg-primary {
        background: linear-gradient(135deg, var(--primary), var(--secondary)) !important;
        }

        .supplier-badge {
        background: linear-gradient(135deg, var(--supplier), #a29bfe) !important;
        color: white;
        }

        .bg-warning {
        background: linear-gradient(135deg, #fdcb6e, #e17055) !important;
        color: white !important;
        }

        .total-price {
        font-weight: 700;
        color: var(--primary);
        }

        .purchase-date {
        color: #636e72;
        font-size: 0.9em;
        }

        .action-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
        }

        .alert {
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
        .container {
            padding: 20px;
            margin: 20px auto;
        }
        
        #addPurchaseForm {
            padding: 15px;
        }
        
        .table td, .table th {
            padding: 8px 10px;
        }
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> 返回主页
        </a>
        <h2 class="mb-0"><i class="bi bi-cart4"></i> 采购记录管理</h2>
        <div style="width: 120px;"></div> <!-- 占位元素保持对称 -->
    </div>

    <!-- 添加采购记录表单 -->
    <form id="addPurchaseForm" class="row g-3">
        <div class="col-md-3">
            <label for="product_id" class="form-label"><i class="bi bi-upc-scan"></i> 商品ID</label>
            <input type="text" class="form-control" id="product_id" required>
        </div>
        <div class="col-md-3">
            <label for="purchase_quantity" class="form-label"><i class="bi bi-box-seam"></i> 采购数量</label>
            <input type="number" class="form-control" id="purchase_quantity" required>
        </div>
        <div class="col-md-3">
            <label for="purchase_unit_price" class="form-label"><i class="bi bi-currency-yen"></i> 采购单价</label>
            <input type="number" step="0.01" class="form-control" id="purchase_unit_price" required>
        </div>
        <div class="col-md-3">
            <label for="purchase_employee_id" class="form-label"><i class="bi bi-person-badge"></i> 采购员工ID</label>
            <input type="text" class="form-control" id="purchase_employee_id" required>
        </div>
        <div class="col-md-3">
            <label for="supplier_id" class="form-label"><i class="bi bi-building"></i> 供应商ID</label>
            <input type="text" class="form-control" id="supplier_id" required>
        </div>
        <div class="col-md-3">
            <label for="purchase_date" class="form-label"><i class="bi bi-calendar-event"></i> 采购时间</label>
            <input type="datetime-local" class="form-control" id="purchase_date" required>
        </div>
        <div class="col-12">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> 添加采购记录
            </button>
        </div>
    </form>

    <!-- 显示采购记录表格 -->
    <table class="table table-hover">
        <thead>
            <tr>
                <th><i class="bi bi-receipt"></i>采购ID</th>
                <th><i class="bi bi-upc"></i>商品ID</th>
                <th><i class="bi bi-box-seam"></i>数量</th>
                <th><i class="bi bi-currency-yen"></i>单价</th>
                <th><i class="bi bi-cash-stack"></i>总价</th>
                <th><i class="bi bi-person-badge"></i>员工ID</th>
                <th><i class="bi bi-person-vcard"></i>供应商ID</th>
                <th><i class="bi bi-clock-history"></i>采购时间</th>
                <th><i class="bi bi-gear"></i>操作</th>
            </tr>
        </thead>
        <tbody id="purchaseTableBody"></tbody>
    </table>
</div>

<script>
    // 格式化日期，只保留到分钟
    function formatToMinute(dateStr) {
        const d = new Date(dateStr);               // 自动解析 2025-06-16 18:34:07 或 2025-06-16T10:34:07Z
        const pad = n => String(n).padStart(2, '0');
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} `
             + `${pad(d.getHours())}:${pad(d.getMinutes())}`;   // 不要 seconds
    }

    // 加载采购记录
    function loadPurchases() {
        fetch('/api/purchases')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('purchaseTableBody');
                tbody.innerHTML = '';
                data.forEach(p => {
                    const row = `<tr>
                        <td>${p.purchase_id}</td>
                        <td><span class="badge bg-primary">${p.product_id}</span></td>
                        <td>${p.purchase_quantity}</td>
                        <td>¥${parseFloat(p.purchase_unit_price).toFixed(2)}</td>
                        <td class="total-price">¥${parseFloat(p.purchase_total_price).toFixed(2)}</td>
                        <td><span class="badge bg-warning text-dark">${p.purchase_employee_id}</span></td>
                        <td><span class="badge supplier-badge">${p.supplier_id}</span></td>
                        <td class="purchase-date">${formatToMinute(p.purchase_date)}</td>
                        <td class="action-buttons">
                            <button class="btn btn-danger btn-sm" onclick="deletePurchase('${p.purchase_id}')">
                                <i class="bi bi-trash"></i> 删除
                            </button>
                        </td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            });
    }

    // 添加采购记录
    document.getElementById('addPurchaseForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const purchase = {
            product_id: document.getElementById('product_id').value,
            purchase_quantity: document.getElementById('purchase_quantity').value,
            purchase_unit_price: document.getElementById('purchase_unit_price').value,
            purchase_employee_id: document.getElementById('purchase_employee_id').value,
            supplier_id: document.getElementById('supplier_id').value,
            purchase_date: document.getElementById('purchase_date').value
        };

        fetch('/api/purchases', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(purchase)
        })
        .then(response => response.json().then(data => ({
            status: response.status,
            ok: response.ok,
            body: data
        })))
        .then(({ status, ok, body }) => {
            if (ok) {
                loadPurchases();
                // 清空表单
                document.getElementById('addPurchaseForm').reset();
                // 显示成功提示
                showAlert('采购记录添加成功！', 'success');
            } else {
                showAlert('添加失败：' + (body.error || "未知错误"), 'danger');
            }
        })
        .catch(error => {
            showAlert('网络或服务器错误：' + error.message, 'danger');
        });
    });

    // 删除采购记录
    function deletePurchase(id) {
        if (confirm('确定要删除这条采购记录吗？此操作不可撤销！')) {
            fetch(`/api/purchases/${id}`, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) {
                        loadPurchases();
                        showAlert('采购记录已删除！', 'success');
                    } else {
                        showAlert('删除失败，请重试', 'danger');
                    }
                })
                .catch(error => {
                    showAlert('删除失败：' + error.message, 'danger');
                });
        }
    }

    // 显示提示信息
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.style.minWidth = '300px';
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // 5秒后自动消失
        setTimeout(() => {
            alertDiv.classList.remove('show');
            setTimeout(() => alertDiv.remove(), 150);
        }, 5000);
    }

    loadPurchases();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>